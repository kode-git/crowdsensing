<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.7/leaflet.css" />
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    <script src="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src='https://api.tiles.mapbox.com/mapbox.js/v1.6.4/mapbox.js'></script>
    <script src="/static/js/leaflet-heat.js"></script>
    <scritp src="./leaflet.ajax.min.js"></script>
    
    <style type="text/css">
    #map-wrapper {
    width: 100%;
    height: 500px;
    position: relative;
    border: 1px solid black;
    }

    #map {
    width: 100%;
    height: 100%;
    }

    #button-wrapper {
    position: absolute;
    bottom: -75px;
    width: 100%;
    margin-left: 10px;
    }
    </style>
</head>

<body>
<div class="span9" style="height:100%">
    <div id="map-wrapper">
        <div id="map"></div>
        <div id="button-wrapper">
            <button class="btn btn-primary" type="submit" id="marker">Show Noise Markers</button>
            <button class="btn btn-primary" type="submit" id="heatmap">Show Noise Heatmap</button>
            <button class="btn btn-primary" type="submit" id="clustering">Show Noise Clustering</button>
            <div class="slidecontainer" min="0" max="10" value="2" step="10">
                <input type="range" min="1" max="50" value="20" step="0.1" class="slider" id="blur">
                <input type="range" min="1" max="100" value="25" step="0.1" class="slider" id="radius">
              </div>
              
        </div> 
        
    </div>
  </div>

<script type="text/javascript">

    //Get current position
    var options = {
    enableHighAccuracy: true,
    timeout: 5000,
    maximumAge: 0
    };

    var map = L.map('map');

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
      
    }).addTo(map);

    map.locate({setView: true, maxZoom: 16});
   var latitudine;
   var longitudine;
    function onLocationFound(e) {
        latitudine=e.latitude;
        longitudine=e.longitude;
        console.log(e.latitude+' .... ' +e.longitude);
    }

    map.on('locationfound', onLocationFound);

    let marker;
    let heat;
    markerLayers = [];
    heatmapLayers=[];

    $("#marker").on("click", e=>{
        e.preventDefault();
        $.ajax({
            url: "/getLocations",
            type: "POST",
            dataType: "json",
            
            success: function(data){
                console.log(provalayer);
                console.log(data[1].st_x);
                
                for(i=0;i<markerLayers.length;i++){
                    map.removeLayer(markerLayers[1]);
                }
                
                for(i=0;i<heatmapLayers.length;i++){
                    map.removeLayer(heatmapLayers[i]);
                }

                for(i=0;i<data.length;i++){
                    markerLayers[1]= new L.layerGroup();

                    marker= new L.marker([data[i].st_x, data[i].st_y])
                    .bindPopup('Noise: ' + data[i].noise + ' <br>Location: '+ data[i].st_x+ ', '+data[i].st_y)
                    .openPopup();
                
                    markerLayers[1].addLayer(marker);
                    map.addLayer(markerLayers[1]);  
                }
            }
        });
    });


    $("#heatmap").on("click", e=>{
        e.preventDefault();
        $.ajax({
            url: "/getLocations",
            type: "POST",
            dataType: "json",
            
            success: function(data){

                for(i=0;i<markerLayers.length;i++){
                    map.removeLayer(markerLayers[i]);
                }
                
                for(i=0;i<heatmapLayers.length;i++){
                    map.removeLayer(heatmapLayers[i]);
                }

                for(i=0;i<data.length;i++){
                
                    heatmapLayers=  L.layerGroup();
                    
                    heat = L.heatLayer([
                        [data[i].st_x, data[i].st_y, data[i].db]], 
                        {blur: 17.2});
                        
                    heatmapLayers.addLayer(heat);
                    
                    
                    console.log("HEAT INSIDE: "+heat);
                 
                }
                
               var prova= L.layerGroup(heatmapLayers);
               heat.addTo(map);
            }
                
        });
    });
   

    
    $("#clustering").on("click", e=>{
        e.preventDefault();
        $.ajax({
            url: "/getLocations",
            type: "POST",
            dataType: "json",
            
            success: function(data){
            }
        })
    });

geoJson2heat = function(geojson) {
    return geojson.features.map(function(feature) {
    return [parseFloat(feature.geometry.coordinates[1]), parseFloat(feature.geometry.coordinates[0]),feature.properties.noise];
    });
}

var heatMap=0;
const provalayer = new L.layerGroup();
map.on('click', function(ev){

    var geodati= {
    "type": "FeatureCollection",
    "prova": 12,
    "features": [{
            "type": "Feature",
            "properties": {
                "Name": "Yishun Community Hospital",
                "Status": "Operational",
                "noise": 3.0
            },
            "geometry": {
                "type": "Point",
                "coordinates": [11.3322379,
                44.5021307
                ]
            }
        },
        {
            "type": "Feature",
            "properties": {
                "Name": "Orso Hospital",
                "Status": "Operational",
                "noise": 3.4
            },
            "geometry": {
                "type": "Point",
                "coordinates": [11.3332379,
                44.5021307
                ]
            }
        },
        {
            "type": "Feature",
            "properties": {
                "VINC": "0",
                "noise": 4.7
            },
            "geometry": {
                "type": "Point",
                "coordinates": [11.3342379,
                44.5021307
                ]
            }
        }
    ]}
    

var geoData = geoJson2heat(geodati, 1);

 heatMap = new L.heatLayer(geoData,{radius: 25, blur: 25, maxZoom: 17});

provalayer.clearLayers();
provalayer.addLayer(heatMap);

map.addLayer(provalayer);


});


var blurslider=document.getElementById("blur");
blurslider.oninput=function(){
    heatMap.setOptions({
        blur: parseInt(this.value)
    });
    // render the new options
    heatMap.redraw();
    document.getElementById("radius").disabled;
}


var radiusslider=document.getElementById("radius");
radiusslider.oninput=function(){
   heatMap.setOptions({
        radius: parseInt(this.value)
    });
    // render the new options
    heatMap.redraw();
    console.log(this.value);
}
   
</script>
</body>
</html>