<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.7/leaflet.css" />
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    <script src="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src='https://api.tiles.mapbox.com/mapbox.js/v1.6.4/mapbox.js'></script>
    <script src="/static/js/leaflet-heat.js"></script>
    <scritp src="./leaflet.ajax.min.js"></script>
    
    <style type="text/css">
    #map-wrapper {
    width: 100%;
    height: 500px;
    position: relative;
    border: 1px solid black;
    }

    #map {
    width: 100%;
    height: 100%;
    }

    #button-wrapper {
    position: absolute;
    bottom: -220px;
    width: 100%;
    margin-left: 20px;
    }
    </style>
</head>

<body>
<div class="span9" style="height:100%">
    
    <div id="map-wrapper">
        <div id="map"></div>
        <div id="button-wrapper">
            <button class="btn btn-primary" type="submit" id="marker">Show Noise Markers</button>
            <button class="btn btn-primary" type="submit" id="heatmap">Show Noise Heatmap</button>
            <button class="btn btn-primary" type="submit" id="clustering">Show Noise Clustering</button>
            <button class="btn btn-primary" type="submit" id="request">POST REQUEST</button>
            <div class="slidecontainer" min="0" max="10" value="2" step="10">
                <input type="range" min="1" max="50" value="15" step="0.1" class="slider" id="blur">
                <input type="range" min="1" max="85" value="25" step="0.1" class="slider" id="radius">
              </div>
              <p>Select a map type:</p>

                <div>
                <input type="radio" id="mapnik" name="drone" value="mapnik"
                        checked>
                <label for="huey">OpenStreetMap Mapnik</label>
                </div>

                <div>
                <input type="radio" id="stadia" name="drone" value="stadia">
                <label for="dewey">Stadia Alidade Smooth Dark</label>
                </div>

                <div>
                <input type="radio" id="thunder" name="drone" value="thunder">
                <label for="louie">Thunder Forest Transport</label>
                </div>   
            </div> 
        
    </div>
  </div>

<script type="text/javascript">

    //Get current position
    var options = {
    enableHighAccuracy: true,
    timeout: 5000,
    maximumAge: 0
    };

    var map = L.map('map');
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);

    map.locate({setView: true, maxZoom: 16});
    var latitudine;
    var longitudine;
    function onLocationFound(e) {
        latitudine=e.latitude;
        longitudine=e.longitude;
        console.log(e.latitude+' .... ' +e.longitude);
    }

    map.on('locationfound', onLocationFound);

    let marker;
    let heat;
    const heatmaplayer = new L.layerGroup();
    const markerlayer = new L.layerGroup();
    markerLayers = [];
    heatmapLayers=[];
    var heatMap=0;


    $("#marker").on("click", e=>{
        e.preventDefault();
        $.ajax({
            url: "/getLocations",
            type: "POST",
            dataType: "json",
            
            success: function(data){
               
                var geojsonMarkerOptions = {
                    radius: 10,
                    fillColor: "#0f8bff",
                    color: "#000",
                    weight: 1,
                    opacity: 1,
                    fillOpacity: 0.8
                };

                marker=L.geoJson(data, {
                    pointToLayer: function (feature, latlng) {
                        return L.circleMarker(latlng, geojsonMarkerOptions);
                    },onEachFeature: function (feature, layer) {
                        layer.bindPopup('<p>Latitude: '+feature.geometry.coordinates[1]+'</p> <p>Longitude: '+feature.geometry.coordinates[0]+'\n </p>');
                    }

                });

                markerlayer.clearLayers();
                heatmaplayer.clearLayers();
                markerlayer.addLayer(marker);
                map.addLayer(markerlayer);    
            }
        });
    });

    


    $("#heatmap").on("click", e=>{
        e.preventDefault();
        $.ajax({
            url: "/getLocations",
            type: "POST",
            dataType: "json",
            
            success: function(data){
               var geoData = geoJson2heat(data, 1);
                console.log(geoData[1]);
                heatMap = new L.heatLayer(geoData,{max: 20.0});
                markerlayer.clearLayers();
                heatmaplayer.clearLayers();
                
                heatmaplayer.addLayer(heatMap);
                
                map.addLayer(heatmaplayer);
            }
                
        });
    });
   

    // CLUSTERING
    var zoom=map.getZoom();
    $("#clustering").on("click", e=>{
        e.preventDefault();
            $.ajax({
                type: 'POST',
                url: '/showClustering',
                dataType: 'json',
                data: {
                    k: parseInt(map.getZoom())
                },

                success: function(data){
                    for(let i=0;i<parseInt(map.getZoom());i++){
                        var polygon = L.polygon(data.clusters[i].geometry.coordinates).addTo(map);
                    }
                }
            })
        });

    
    /*
// TEST FOR POLYGON 
    $("#clustering2").on("click", e=>{
        e.preventDefault();
        $.ajax({
            url: "/showClustering",
            type: "POST",
            dataType: "json",
            
            success: function(data){
                var states = [{
                    "type": "Feature",
                    "properties": {"party": "Bologna"},
                    "geometry": {
                        "type": "Polygon",
                        "coordinates": [[
                            [11.338301255783536,44.4958609349294],
                            [11.34220655210922,44.50081979701788  ],
                            [11.353836610397794,44.49809553609738  ],
                            [11.350231721481778,44.490319979079864   ],
                            [11.343021943649747, 44.492095591313145   ]
                        ]]
                    }
                }];

                L.geoJson(states, {
                    style: function(feature) {
                        switch (feature.properties.party) {
                            case 'Bologna': return {color: "#0000ff"};
                        }
                    }
                });


                var layer = new L.geoJson(states, {
                onEachFeature: function (feature, layer) {
                    layer.on('mouseover', function () {
                    this.setStyle({
                        'fillColor': '#0000ff'
                    });
                    });
                    layer.on('mouseout', function () {
                    this.setStyle({
                        'fillColor': '#ff0000'
                    });
                    });
                    layer.on('click', function () {
                    // Let's say you've got a property called url in your geojsonfeature:
                    alert("Hello! I am an alert box!!");
                    });
                }
                }).addTo(map);
            }
        })
    });

*/

    
  

//TODO: CLUSTERING WHILE ZOOMING

//Zoom level goes from 0 to 19
/*
const zoomarker = new L.layerGroup();
map.on('zoomend', function() {
  var currentZoom = map.getZoom();
  $.ajax({
            url: "/getLocations",
            type: "POST",
            dataType: "json",
            
            success: function(data){
                console.log(map.getZoom());
               
                if(map.getZoom()<13){
                    zoomarker.clearLayers();
                    var marker = L.marker([44.50081979701788,11.34220655210922], { title: "My marker" }).addTo(map);
                zoomarker.addLayer(marker);
                
                map.addLayer(zoomarker);
                }else{
                    zoomarker.clearLayers();
                    var marker = L.marker([44.51081979701788,11.35220655210922], { title: "My marker" }).addTo(map);
                zoomarker.addLayer(marker);
                
                map.addLayer(zoomarker);
                }
            }
                
        });
});*/

//SET GEOJSON FOR HEATMAP FUNCTION
geoJson2heat = function(geojson) {
    return geojson.features.map(function(feature) {
    return [parseFloat(feature.geometry.coordinates[1]), parseFloat(feature.geometry.coordinates[0]),feature.properties.db];
    });
}

//HEATMAP BLUR SLIDER
var blurslider=document.getElementById("blur");
blurslider.oninput=function(){
    heatMap.setOptions({
        blur: parseInt(this.value)
    });
    // render the new options
    heatMap.redraw();
}

//HEATMAP RADIUS SLIDER
var radiusslider=document.getElementById("radius");
radiusslider.oninput=function(){
   heatMap.setOptions({
        radius: parseInt(this.value)
    });
     // render the new options
    heatMap.redraw();
}

//MAP STYLE RADIO BUTTON
$('input[type="radio"]').on('click',function(){
     var value = $(this).val();
     
     var name = $(this).attr('value');
     if(value=='mapnik'){
     L.tileLayer('https://{s}.tile.openstreetmap.de/tiles/osmde/{z}/{x}/{y}.png', {
	maxZoom: 18,
	attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
}).addTo(map);
}else if(value=='thunder'){
    var Thunderforest_Transport = L.tileLayer('https://{s}.tile.thunderforest.com/transport/{z}/{x}/{y}.png?apikey={apikey}', {
	attribution: '&copy; <a href="http://www.thunderforest.com/">Thunderforest</a>, &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
	apikey: '4d975f2a48924ef0beda223fc08d16ef',
	maxZoom: 22
}).addTo(map);
}else if(value=='stadia'){
    var Stadia_AlidadeSmoothDark = L.tileLayer('https://tiles.stadiamaps.com/tiles/alidade_smooth_dark/{z}/{x}/{y}{r}.png', {
	maxZoom: 20,
    r:'f7bbae07-5f38-4731-92c2-3f977975be0a',
	attribution: '&copy; <a href="https://stadiamaps.com/">Stadia Maps</a>, &copy; <a href="https://openmaptiles.org/">OpenMapTiles</a> &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors'
}).addTo(map);
}
});

//



</script>
</body>
</html>