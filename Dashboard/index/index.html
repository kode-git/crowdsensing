<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.7/leaflet.css" />
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    <script src="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src='https://api.tiles.mapbox.com/mapbox.js/v1.6.4/mapbox.js'></script>
    <script src="/static/js/leaflet-heat.js"></script>
    <scritp src="./leaflet.ajax.min.js"></script>
    
    <style type="text/css">
    #map-wrapper {
    width: 100%;
    height: 500px;
    position: relative;
    border: 1px solid black;
    }

    #map {
    width: 100%;
    height: 100%;
    }

    #button-wrapper {
    position: absolute;
    bottom: -220px;
    width: 100%;
    margin-left: 20px;
    }
    </style>
</head>

<body>
<div class="span9" style="height:100%">
    
    <div id="map-wrapper">
        <div id="map"></div>
        <div id="button-wrapper">
            <button class="btn btn-primary" type="submit" id="marker">Show Noise Markers</button>
            <button class="btn btn-primary" type="submit" id="heatmap">Show Noise Heatmap</button>
            <button class="btn btn-primary" type="submit" id="clustering">Show Noise Clustering</button>
            <button class="btn btn-primary" type="submit" id="request">POST REQUEST</button>
            <div class="slidecontainer" min="0" max="10" value="2" step="10">
                <input type="range" min="1" max="50" value="20" step="0.1" class="slider" id="blur">
                <input type="range" min="1" max="85" value="25" step="0.1" class="slider" id="radius">
              </div>
              <p>Select a map type:</p>

                <div>
                <input type="radio" id="mapnik" name="drone" value="mapnik"
                        checked>
                <label for="huey">OpenStreetMap Mapnik</label>
                </div>

                <div>
                <input type="radio" id="stadia" name="drone" value="stadia">
                <label for="dewey">Stadia Alidade Smooth Dark</label>
                </div>

                <div>
                <input type="radio" id="thunder" name="drone" value="thunder">
                <label for="louie">Thunder Forest Transport</label>
                </div>   
            </div> 
        
    </div>
  </div>

<script type="text/javascript">

    //Get current position
    var options = {
    enableHighAccuracy: true,
    timeout: 5000,
    maximumAge: 0
    };

    var map = L.map('map');
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
	maxZoom: 19,
	attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
}).addTo(map);

    map.locate({setView: true, maxZoom: 16});
   var latitudine;
   var longitudine;
    function onLocationFound(e) {
        latitudine=e.latitude;
        longitudine=e.longitude;
        console.log(e.latitude+' .... ' +e.longitude);
    }

    map.on('locationfound', onLocationFound);

    let marker;
    let heat;
    markerLayers = [];
    heatmapLayers=[];

    $("#marker").on("click", e=>{
        e.preventDefault();
        $.ajax({
            url: "/getLocations",
            type: "POST",
            dataType: "json",
            
            success: function(data){
               
                var geojsonMarkerOptions = {
                    radius: 10,
                    fillColor: "#0f8bff",
                    color: "#000",
                    weight: 1,
                    opacity: 1,
                    fillOpacity: 0.8
                };
                marker=L.geoJson(data, {
                pointToLayer: function (feature, latlng) {
                return L.circleMarker(latlng, geojsonMarkerOptions);
                    },onEachFeature: function (feature, layer) {
    layer.bindPopup('<p>Latitude: '+feature.geometry.coordinates[1]+'</p> <p>Longitude: '+feature.geometry.coordinates[0]+'\n </p>');
  }

                });

                markerlayer.clearLayers();
                heatmaplayer.clearLayers();
                markerlayer.addLayer(marker);
                console.log(data);
                map.addLayer(markerlayer);
                
                
            }
        });
    });



    $("#heatmap").on("click", e=>{
        e.preventDefault();
        $.ajax({
            url: "/getLocations",
            type: "POST",
            dataType: "json",
            
            success: function(data){
                var geoData = geoJson2heat(data, 1);
                heatMap = new L.heatLayer(geoData,{radius: 25, blur: 25, maxZoom: 17});
                markerlayer.clearLayers();
                heatmaplayer.clearLayers();
                
                heatmaplayer.addLayer(heatMap);
                
                map.addLayer(heatmaplayer);
            }
                
        });
    });
   

// TEST FOR POLYGON 
    $("#clustering").on("click", e=>{
        e.preventDefault();
        $.ajax({
            url: "/getLocations",
            type: "POST",
            dataType: "json",
            
            success: function(data){
                var states = [{
                    "type": "Feature",
                    "properties": {"party": "Bologna"},
                    "geometry": {
                        "type": "Polygon",
                        "coordinates": [[
                            [11.338301255783536,44.4958609349294],
                            [11.34220655210922,44.50081979701788  ],
                            [11.353836610397794,44.49809553609738  ],
                            [11.350231721481778,44.490319979079864   ],
                            [11.343021943649747, 44.492095591313145   ]
                        ]]
                    }
                }];

                L.geoJson(states, {
                    style: function(feature) {
                        switch (feature.properties.party) {
                            case 'Bologna': return {color: "#0000ff"};
                        }
                    }
                });


                var layer = new L.geoJson(states, {
                onEachFeature: function (feature, layer) {
                    layer.on('mouseover', function () {
                    this.setStyle({
                        'fillColor': '#0000ff'
                    });
                    });
                    layer.on('mouseout', function () {
                    this.setStyle({
                        'fillColor': '#ff0000'
                    });
                    });
                    layer.on('click', function () {
                    // Let's say you've got a property called url in your geojsonfeature:
                    alert("Hello! I am an alert box!!");
                    });
                }
                }).addTo(map);
            }
        })
    });



    
  

//TODO: CLUSTERING WHILE ZOOMING

//Zoom level goes from 0 to 19

const zoomarker = new L.layerGroup();
map.on('zoomend', function() {
  var currentZoom = map.getZoom();
  $.ajax({
            url: "/getLocations",
            type: "POST",
            dataType: "json",
            
            success: function(data){
                console.log(map.getZoom());
               
                if(map.getZoom()<13){
                    zoomarker.clearLayers();
                    var marker = L.marker([44.50081979701788,11.34220655210922], { title: "My marker" }).addTo(map);
                zoomarker.addLayer(marker);
                
                map.addLayer(zoomarker);
                }else{
                    zoomarker.clearLayers();
                    var marker = L.marker([44.51081979701788,11.35220655210922], { title: "My marker" }).addTo(map);
                zoomarker.addLayer(marker);
                
                map.addLayer(zoomarker);
                }
            }
                
        });
});

//SET GEOJSON FOR HEATMAP FUNCTION
geoJson2heat = function(geojson) {
    return geojson.features.map(function(feature) {
    return [parseFloat(feature.geometry.coordinates[1]), parseFloat(feature.geometry.coordinates[0]),(feature.properties.db)];
    });
}

var heatMap=0;
const heatmaplayer = new L.layerGroup();
const markerlayer = new L.layerGroup();

/*
map.on('click', function(ev){

    var geodati= {
    "type": "blabla",
    "prova": 12,
    "features": [{
            "type": "prova",
            "properties": {
                "Name": "Yishun Community Hospital",
                "Status": "Operational",
                "noise": 3.0
            },
            "geometry": {
                "type": "Point",
                "coordinates": [44.5021307,11.3322379            
                ]
            }
        },
        {
            "type": "aaa",
            "properties": {
                "Name": "Orso Hospital",
                "Status": "Operational",
                "noise": 3.4
            },
            "geometry": {
                "type": "Point",
                "coordinates": [44.5021307,11.3332379
                
                ]
            }
        },
        {
            "type": "Featurrre",
            "properties": {
                "VINC": "0",
                "noise": 4.7
            },
            "geometry": {
                "type": "Point",
                "coordinates": [
                44.5021307,11.3342379
                ]
            }
        }
    ]}
    

var geoData = geoJson2heat(geodati, 1);

 heatMap = new L.heatLayer(geoData,{radius: 25, blur: 25, maxZoom: 17}).addTo(map);



}); */


//HEATMAP BLUR SLIDER
var blurslider=document.getElementById("blur");
blurslider.oninput=function(){
    heatMap.setOptions({
        blur: parseInt(this.value)
    });
    // render the new options
    heatMap.redraw();
}

//HEATMAP RADIUS SLIDER
var radiusslider=document.getElementById("radius");
radiusslider.oninput=function(){
   heatMap.setOptions({
        radius: parseInt(this.value)
    });
     // render the new options
    heatMap.redraw();
}

//MAP STYLE RADIO BUTTON
$('input[type="radio"]').on('click',function(){
     var value = $(this).val();
     
     var name = $(this).attr('value');
     if(value=='stadia'){
     L.tileLayer('https://{s}.tile.openstreetmap.de/tiles/osmde/{z}/{x}/{y}.png', {
	maxZoom: 18,
	attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
}).addTo(map);
}else{
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
	maxZoom: 19,
	attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
}).addTo(map);}
});



</script>
</body>
</html>